<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WiremockServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">happycows</a> &gt; <a href="index.source.html" class="el_package">edu.ucsb.cs156.happiercows.services.wiremock</a> &gt; <span class="el_source">WiremockServiceImpl.java</span></div><h1>WiremockServiceImpl.java</h1><pre class="source lang-java linenums">package edu.ucsb.cs156.happiercows.services.wiremock;

import lombok.extern.slf4j.Slf4j;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.context.annotation.Profile;
import org.springframework.stereotype.Service;

import com.github.tomakehurst.wiremock.WireMockServer;
import com.github.tomakehurst.wiremock.extension.responsetemplating.ResponseTemplateTransformer;
import com.github.tomakehurst.wiremock.junit.Stubbing;

import static com.github.tomakehurst.wiremock.client.WireMock.aResponse;
import static com.github.tomakehurst.wiremock.client.WireMock.get;
import static com.github.tomakehurst.wiremock.client.WireMock.okJson;
import static com.github.tomakehurst.wiremock.client.WireMock.post;
import static com.github.tomakehurst.wiremock.client.WireMock.temporaryRedirect;
import static com.github.tomakehurst.wiremock.client.WireMock.urlPathEqualTo;
import static com.github.tomakehurst.wiremock.client.WireMock.urlPathMatching;
import static com.github.tomakehurst.wiremock.core.WireMockConfiguration.options;

/**
 * This is a service for mocking authentication using wiremock
 * 
 * This class relies on property values. For hints on testing, see: &lt;a href=
 * &quot;https://www.baeldung.com/spring-boot-testing-configurationproperties&quot;&gt;https://www.baeldung.com/spring-boot-testing-configurationproperties&lt;/a&gt;
 * 
 */
<span class="nc" id="L28">@Slf4j</span>
@Service(&quot;wiremockService&quot;)
@Profile(&quot;wiremock&quot;)
@ConfigurationProperties
<span class="nc" id="L32">public class WiremockServiceImpl extends WiremockService {</span>

  WireMockServer wireMockServer;

  /**
   * This method returns the wiremockServer
   * 
   * @return the wiremockServer
   */
  public WireMockServer getWiremockServer() {
<span class="nc" id="L42">    return wireMockServer;</span>
  }

  /**
   * This method sets up the necessary mocks for authentication
   * 
   * @param s in an instance of a WireMockServer or WireMockExtension
   */
  public static void setupOauthMocks(Stubbing s, boolean isAdmin) {

<span class="nc" id="L52">    s.stubFor(get(urlPathMatching(&quot;/oauth/authorize.*&quot;))</span>
<span class="nc" id="L53">        .willReturn(aResponse()</span>
<span class="nc" id="L54">            .withStatus(200)</span>
<span class="nc" id="L55">            .withHeader(&quot;Content-Type&quot;, &quot;text/html&quot;)</span>
<span class="nc" id="L56">            .withBodyFile(&quot;login.html&quot;)));</span>

<span class="nc" id="L58">    s.stubFor(post(urlPathEqualTo(&quot;/login&quot;))</span>
<span class="nc" id="L59">        .willReturn(temporaryRedirect(</span>
            &quot;{{formData request.body 'form' urlDecode=true}}{{{form.redirectUri}}}?code={{{randomValue length=30 type='ALPHANUMERIC'}}}&amp;state={{{form.state}}}&quot;)));

<span class="nc" id="L62">    s.stubFor(post(urlPathEqualTo(&quot;/oauth/token&quot;))</span>
<span class="nc" id="L63">        .willReturn(</span>
<span class="nc" id="L64">            okJson(</span>
                &quot;{\&quot;access_token\&quot;:\&quot;{{randomValue length=20 type='ALPHANUMERIC'}}\&quot;,\&quot;token_type\&quot;: \&quot;Bearer\&quot;,\&quot;expires_in\&quot;:\&quot;3600\&quot;,\&quot;scope\&quot;:\&quot;https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email openid\&quot;}&quot;)));

<span class="nc bnc" id="L67" title="All 2 branches missed.">    if (isAdmin) {</span>
<span class="nc" id="L68">      s.stubFor(get(urlPathMatching(&quot;/userinfo&quot;))</span>
<span class="nc" id="L69">          .willReturn(aResponse()</span>
<span class="nc" id="L70">              .withStatus(200)</span>
<span class="nc" id="L71">              .withHeader(&quot;Content-Type&quot;, &quot;application/json&quot;)</span>
<span class="nc" id="L72">              .withBody(</span>
                  &quot;&quot;&quot;
                      {
                        &quot;sub&quot;: &quot;107126842018026740288&quot;,
                        &quot;name&quot;: &quot;Admin GaucSho&quot;,
                        &quot;given_name&quot;: &quot;Admin&quot;,
                        &quot;family_name&quot;: &quot;Gaucho&quot;,
                        &quot;picture&quot;: &quot;https://lh3.googleusercontent.com/a/ACg8ocJpOe2SqIpirdIMx7KTj1W4OQ45t6FwpUo40K2V2JON=s96-c&quot;,
                        &quot;email&quot;: &quot;admingaucho@ucsb.edu&quot;,
                        &quot;email_verified&quot;: true,
                        &quot;locale&quot;: &quot;en&quot;,
                        &quot;hd&quot;: &quot;ucsb.edu&quot;
                      }
                      &quot;&quot;&quot;)));
    } else {
<span class="nc" id="L87">      s.stubFor(get(urlPathMatching(&quot;/userinfo&quot;))</span>
<span class="nc" id="L88">          .willReturn(aResponse()</span>
<span class="nc" id="L89">              .withStatus(200)</span>
<span class="nc" id="L90">              .withHeader(&quot;Content-Type&quot;, &quot;application/json&quot;)</span>
<span class="nc" id="L91">              .withBody(</span>
                  &quot;&quot;&quot;
                      {
                        &quot;sub&quot;: &quot;107126842018026740288&quot;,
                        &quot;name&quot;: &quot;Chris Gaucho&quot;,
                        &quot;given_name&quot;: &quot;Chris&quot;,
                        &quot;family_name&quot;: &quot;Gaucho&quot;,
                        &quot;picture&quot;: &quot;https://lh3.googleusercontent.com/a/ACg8ocJpOe2SqIpirdIMx7KTj1W4OQ45t6FwpUo40K2V2JON=s96-c&quot;,
                        &quot;email&quot;: &quot;cgaucho@ucsb.edu&quot;,
                        &quot;email_verified&quot;: true,
                        &quot;locale&quot;: &quot;en&quot;,
                        &quot;hd&quot;: &quot;ucsb.edu&quot;
                      }
                      &quot;&quot;&quot;)));
    }

<span class="nc" id="L107">  }</span>

  /**
   * This method initializes the WireMockServer
   */
  public void init() {
<span class="nc" id="L113">    log.info(&quot;WiremockServiceImpl.init() called&quot;);</span>

<span class="nc" id="L115">    WireMockServer wireMockServer = new WireMockServer(options()</span>
<span class="nc" id="L116">        .port(8090) // No-args constructor will start on port</span>
<span class="nc" id="L117">        .extensions(new ResponseTemplateTransformer(true)));</span>

<span class="nc" id="L119">    setupOauthMocks(wireMockServer, true);</span>

<span class="nc" id="L121">    wireMockServer.start();</span>

<span class="nc" id="L123">    log.info(&quot;WiremockServiceImpl.init() completed&quot;);</span>
<span class="nc" id="L124">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>